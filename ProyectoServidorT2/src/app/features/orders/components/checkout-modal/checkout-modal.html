<div class="modal-overlay" *ngIf="isOpen" (click)="onOverlayClick($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Finalizar Pedido</h2>
      <button class="close-btn" (click)="onCloseRequest()">&times;</button>
    </div>
    
    <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="calle">Calle</label>
        <input type="text" id="calle" formControlName="calle" placeholder="Nombre de la calle" 
               [class.invalid]="isFieldInvalid('calle')">
      </div>

      <div class="form-row three-col">
        <div class="form-group">
          <label for="numero">Número</label>
          <input type="text" id="numero" formControlName="numero" placeholder="Nº"
                 [class.invalid]="isFieldInvalid('numero')">
        </div>
        
        <div class="form-group">
          <label for="piso">Piso</label>
          <input type="text" id="piso" formControlName="piso" placeholder="Piso">
        </div>

        <div class="form-group">
          <label for="puerta">Puerta</label>
          <input type="text" id="puerta" formControlName="puerta" placeholder="Pta">
        </div>
      </div>

      <div class="form-row three-col">
        <div class="form-group">
          <label for="codigo_postal">Código Postal</label>
          <input type="text" id="codigo_postal" formControlName="codigo_postal" placeholder="00000"
                 [class.invalid]="isFieldInvalid('codigo_postal')">
        </div>

        <div class="form-group">
          <label for="ciudad">Ciudad</label>
          <input type="text" id="ciudad" formControlName="ciudad" placeholder="Ciudad"
                 [class.invalid]="isFieldInvalid('ciudad')">
        </div>
        
        <div class="form-group">
          <label for="provincia">Provincia</label>
          <input type="text" id="provincia" formControlName="provincia" placeholder="Provincia"
                 [class.invalid]="isFieldInvalid('provincia')">
        </div>
      </div>

      <div class="form-group">
        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" formControlName="observaciones" rows="3" placeholder="Información adicional para el repartidor..."></textarea>
      </div>

      <div class="checkout-items">
        <h3>Resumen del Pedido</h3>
        <div class="items-list">
          <div class="checkout-item" *ngFor="let item of cartItems">
            <img [src]="item.image" [alt]="item.name" class="item-img">
            <div class="item-info">
              <span class="item-name">{{ item.name }}</span>
              <span class="item-price">{{ (item.price * item.quantityInCart) | currency:'EUR' }}</span>
            </div>
            
            <div class="quantity-controls">
                <button type="button" (click)="decreaseQuantity(item)">-</button>
                <span>{{ item.quantityInCart }}</span>
                <button type="button" (click)="increaseQuantity(item)" [disabled]="item.quantityInCart >= 5">+</button>
            </div>

            <button type="button" class="remove-btn" (click)="askRemoveItem(item.id)" title="Eliminar producto">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="order-summary">
        <p>Total a pagar: <strong>{{ totalAmount | currency:'EUR' }}</strong></p>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="onCloseRequest()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="checkoutForm.invalid || isSubmitting || cartItems.length === 0">
          {{ isSubmitting ? 'Procesando...' : 'Confirmar Pedido' }}
        </button>
      </div>
    </form>
  </div>
</div>

<app-confirmation-modal
  [isOpen]="showConfirmation"
  title="Cancelar pedido"
  message="¿Estás seguro de que deseas cerrar? Se perderán los datos introducidos."
  (confirm)="onConfirmClose()"
  (cancel)="onCancelClose()"
>
</app-confirmation-modal>

<app-confirmation-modal
  [isOpen]="showRemoveConfirmation"
  title="Eliminar producto"
  message="¿Estás seguro de que quieres eliminar este producto del pedido?"
  (confirm)="confirmRemoveItem()"
  (cancel)="cancelRemoveItem()"
>
</app-confirmation-modal>
